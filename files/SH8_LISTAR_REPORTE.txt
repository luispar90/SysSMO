#!/bin/sh
clear
#HOME_GAT=/home/usrqalnxsu/USRMSSAP/MSSAP_Usuario/CARGAMASIVA60
#HOME_GAT=/home/T11645/EVERIS/MSSAP/v60
HOME_GAT=/home/USRMSSAP/mssap/CARGAMASIVA60
. $HOME_GAT/BIN/.passet
. $HOME_GAT/BIN/.varset

FECHA_HORA=`date +%Y%m%d%H%M%S`
LOG=$DIRLOG/log_${FECHA_HORA}.log
ARCHIVO_EXP=REPORTE_${FECHA_HORA}.csv
ARCHIVO_EXP_TLV=REPORTE_TELEVENTAS_${FECHA_HORA}.csv
DAT=$DIRDAT/$ARCHIVO_EXP
DAT_TELEVENTAS=$DIRDAT/$ARCHIVO_EXP_TLV
FILELOG=log${FECHA_HORA}.log

#-----------------------------------------------------------------
#       FUNCION PARA MANEJO DEL LOG
#-----------------------------------------------------------------
pMessage () {
   LOGDATE=`date +"%d-%m-%Y %H:%M:%S"`
   echo "($LOGDATE) $*"
   echo "($LOGDATE) $*"  >> ${DIRLOG}/$FILELOG
} # pMessage

########## Definición de variables #############################################
hora=`date +"%d-%m-%Y %H:%M:%S"`
USUARIO="USRMSSAP"
SHELL=SH_REPORTE.sh
HOST=`hostname`
IP_ORIGEN=`cat /etc/hosts | grep -v '#' | grep ${HOST} | awk '{print $1}'`
#TABLA=SSAPT_VENTASERIE

#-------------------------------------------------------------------------------
# Funcion: exitScript
# Descripcion: Funcion que termina con la ejecucion de la fase saliendo por error
# y llamando a la función pMessage con el mensaje de error.
# Parámetros:   $1 - Codigo de Error
#               $2 - Mensaje de Error
#-------------------------------------------------------------------------------

exitScript()
{
CODERROR=$1
CODERROR=0
MENSAJE=$2
pMessage "${MENSAJE}"
exit $CODERROR
}

#-------------------------------
#-------------------------------

pMessage "************************************* "
pMessage "Iniciando proceso                     "
pMessage "Fecha y Hora  : ${hora}               "
pMessage "Usuario :  ${USUARIO}                 "
pMessage "Shell : ${SHELL}                      "
pMessage "Ip : ${IP_ORIGEN}                     "
pMessage "Host : ${HOST}                        "
pMessage "**************************************"$'\n'

sqlplus -S ${USER_MSSAP}/${PASSWORD_MSSAP}@${BD_MSSAP} <<EOP > ${DAT}
set arraysize 5000;
set flush on;
set buffer 500000000;
set heading off;
set feedback off;
set timing off;
set space 0;
set linesize 4000;
set echo off;
set trim on;
set termout on;
set serveroutput on size 50000;
set underline off;
set trims on;
set verify off;
set newpage none;

--cabeceras
select  'PEDIN_NROPEDIDO'||'|'||
        'NRO_REFERENCIA'||'|'||
        'ORGANIZACION_VENTA'||'|'||  -- DATO NO ENTRAGADO POR SAP PARA DISTRIBUIDORES
        'CANAL_DISTRIBUICION'||'|'||
        'SECTOR'||'|'||
        'DPTO_DAC'||'|'||
        'REGION_DAC'||'|'||
        'CODIGO_PTO_VENTA'||'|'||
        'PUNTO_VENTA'||'|'||
        'PDV_PADRE'||'|'||
        'PDV_NOMBRE_PADRE'||'|'||
        'PDV_CODIGO_ALMACEN'||'|'||
        'PDV_CENTRO'||'|'||
        'FECHA_CONSIGNACION'||'|'||
        'TIPO_VENTA'||'|'||
        'TPODOC'||'|'||
        'TIPO_PRODUCTO'||'|'||
        'MATERIAL'||'|'||
        'NOMBRE_MATERIAL'||'|'|| 
        'SERIE'||'|'||
        'DIAS_CONSIGNADO'||'|'|| 
        'ESTADO'||'|'||
        'TELEFONO'||'|'||
        'DSC_OFICINA_VENTA'||'|'||
        'PRECIO_VTA_SIMCARD'||'|'||
        'PRECIO_VTA_EQUIPO'||'|'||
        'PRECIO_VTA_TOTAL_SIN_IGV'||'|'||
        'DESCUENTO_TRIBUTARIO_TOTAL'||'|'||
        'DESCUENTO_TRIBUTARIO_MATERIAL'||'|'||
        'OTROS_DESCUENTO_MATERIAL'||'|'||
        'PRECIO_VTA_TOTAL_CON_IGV'||'|'||
        'PRECIO_BASE_MATERIAL'||'|'||
        'LISTA_PRECIO'||'|'||
        'DSC_LISTA_PRECIO'||'|'||
        'FECHA_VENTA'||'|'||
        'FLG_ACTIVACION'||'|'||
        'FCH_ACTIVA'||'|'||
        'ESTADO_ACTIVACION'||'|'||
        'FECHA_CREACION'
from mssap60.ssapt_pedido
where rownum = 1;
                ---select Distribuidores
select mssap60.ssapt_pedido.pedin_nropedido||'|'||  
      (
        case DECODE(mssap60.ssapt_pedido.pediv_sistemaventa, 'SISACT PRE', 'SISACTPRE', mssap60.ssapt_pedido.pediv_sistemaventa) 
          when 'SISACTPRE' then
               case  mssap60.ssapt_pedido.pedic_codtipooperacion 
                 when '03' then
                      (select numero_referencia  from USRPVU.SISACT_VENTA_REPO_PRE@DBL_PVU  where pedido_sinergia = TO_CHAR(mssap60.ssapt_pedido.PEDIN_NROPEDIDO))
                 else
                      (select VEPR_NUMERO_REFERENCIA from USRPVU.SISACT_VENTA_PREPAGO_DATOS@DBL_PVU  where VEPR_PEDIDO_SINERGIA = TO_CHAR(mssap60.ssapt_pedido.PEDIN_NROPEDIDO))
               end
          when 'SISACT' then
                (
				SELECT v.numero_referencia 
				FROM USRPVU.SISACT_ap_vENTA@DBL_PVU v 
					   inner join USRPVU.sisact_info_venta_sap@DBL_PVU vs
					   on vs.id_venta = v.id_documento
				where  vs.nro_documento = TO_CHAR(mssap60.ssapt_pedido.PEDIN_NROPEDIDO)
				and    vs.tipo_documento = 'F'
                )
        end
        )||'|'||
        '' ||'|'||
        'DISTRIBUIDOR AUTORIZADO' ||'|'||
        mssap60.ssapt_pedido.PEDIC_SECTOR ||'|'||
        mssap60.ssapt_interlocutor.intec_region ||'|'||
        mssap60.ssapt_interlocutor.intec_region ||'|'||
        mssap60.ssapt_pedido.intev_codinterlocutor ||'|'||
        mssap60.ssapt_interlocutor.intev_descinterlocutor ||'|'||
        mssap60.ssapt_interlocutor.intev_codpadre ||'|'||
        mssap60.ssapt_interlocutor.intev_descpadre ||'|'||
        mssap60.ssapt_interlocutor.intec_codalmacen ||'|'||
        mssap60.ssapt_interlocutor.intec_codcentro ||'|'||
        to_char(mssap60.ssapt_stockimei.stckd_fechadocumento,'YYYYMMDD') ||'|'||
        case mssap60.ssapt_pedido.PEDIC_TIPOVENTA when '01' then 'POSTPAGO' when '02' then 'PREPAGO' when '07' then 'TFI' else null end ||'|'||
        mssap60.ssapt_pedido.pediv_descclasefactura ||'|'||
        decode(mat.matec_tipomaterial, 'TV0004', 'CHIP', 'TV0003', 'EQUIPO', 'OTROS') ||'|'||
        mssap60.ssapt_detallepedido.depec_codmaterial ||'|'|| mat.matev_descmaterial ||'|'|| mssap60.ssapt_detallepedido.seric_codserie ||'|'||
        ROUND(mssap60.ssapt_detallepedido.deped_fechamodi- mssap60.ssapt_stockimei.stckd_fechadocumento) ||'|'|| nvl(mssap60.ssapt_stockimei.stckc_status,'V') ||'|'||
        mssap60.ssapt_detallepedido.depev_nrotelefono ||'|'|| '' ||'|'||
        decode(mat.matec_tipomaterial, 'TV0004', mssap60.ssapt_detallepedido.depen_precioventa, 0) ||'|'||
        decode(mat.matec_tipomaterial, 'TV0003', mssap60.ssapt_detallepedido.depen_precioventa, 0) ||'|'||
        mssap60.ssapt_intencionpago.inpan_totalmercaderia ||'|'||
        mssap60.ssapt_intencionpago.inpan_totaldescuento ||'|'||
        (
        select  SUM(NVL(sdp.descn_monto,0))
        from    mssap60.ssapt_descuentoproducto sdp
        where   sdp.pedin_nropedido = mssap60.ssapt_pedido.pedin_nropedido
        and     sdp.descc_codserie = mssap60.ssapt_detallepedido.seric_codserie
       and     sdp.clcoc_codclasecondicion IN ('ZD51','ZD54') -- descuento tributario
        ) ||'|'||
        (
        select  sum(sdp.descn_monto)
        from    mssap60.ssapt_descuentoproducto sdp
        where   sdp.pedin_nropedido = mssap60.ssapt_pedido.pedin_nropedido
        and     sdp.descc_codserie = mssap60.ssapt_detallepedido.seric_codserie
        and     sdp.clcoc_codclasecondicion in ('ZD52', 'ZD53' , 'ZD55') -- otros descuento
        ) ||'|'||
        mssap60.ssapt_intencionpago.inpan_totalconigv ||'|'||
        mat.maten_preciobase ||'|'||
        mssap60.ssapt_detallepedido.depev_codigolp ||'|'||
        mssap60.ssapt_detallepedido.depev_descripcionlp ||'|'||
        to_char(mssap60.ssapt_detallepedido.Deped_Fechamodi,'YYYYMMDD') ||'|'||
        mssap60.ssapt_pedido.pediv_sistemaventa ||'|'||
        '' ||'|'||
        '' ||'|'||
        mssap60.ssapt_detallepedido.deped_fechacrea
from mssap60.ssapt_pedido
inner join mssap60.ssapt_interlocutor
on mssap60.ssapt_interlocutor.intev_codinterlocutor = mssap60.ssapt_pedido.intev_codinterlocutor
and mssap60.ssapt_interlocutor.intec_canaldistribucion = '12' -- 12 distribuidores, 13 Cadenas
inner join mssap60.ssapt_detallepedido
on mssap60.ssapt_detallepedido.pedin_nropedido = mssap60.ssapt_pedido.pedin_nropedido
left join mssap60.ssapt_stockimei
on mssap60.ssapt_stockimei.stckc_codserie = mssap60.ssapt_detallepedido.seric_codserie
inner join mssap60.ssapt_material mat
on mat.matec_codmaterial = mssap60.ssapt_detallepedido.depec_codmaterial and mat.matec_tipomaterial in ('TV0004','TV0003')
inner join mssap60.ssapt_intencionpago
on mssap60.ssapt_intencionpago.pedin_nropedido = mssap60.ssapt_pedido.pedin_nropedido
where mssap60.ssapt_pedido.pedic_estado = 'PAG' -- EJECUCION DE PAGO DESDE LEGADO
and trunc(mssap60.ssapt_pedido.pedid_fechadocumento) = trunc(sysdate)
--and mssap60.ssapt_pedido.pediv_estadoflujo = '002'  -- HAN SIDO ENVIADO A SAP
union all ---select Cadenas
select  mssap60.ssapt_pedido.pedin_nropedido ||'|'||
        (
        case DECODE(mssap60.ssapt_pedido.pediv_sistemaventa, 'SISACT PRE', 'SISACTPRE', mssap60.ssapt_pedido.pediv_sistemaventa) 
          when 'SISACTPRE' then
               case  mssap60.ssapt_pedido.pedic_codtipooperacion 
                 when '03' then
                      (select numero_referencia  from USRPVU.SISACT_VENTA_REPO_PRE@DBL_PVU  where pedido_sinergia = TO_CHAR(mssap60.ssapt_pedido.PEDIN_NROPEDIDO))
                 else
                      (select VEPR_NUMERO_REFERENCIA from USRPVU.SISACT_VENTA_PREPAGO_DATOS@DBL_PVU  where VEPR_PEDIDO_SINERGIA = TO_CHAR(mssap60.ssapt_pedido.PEDIN_NROPEDIDO))
               end
          when 'SISACT' then
                (
                SELECT v.numero_referencia 
                FROM USRPVU.SISACT_ap_vENTA@DBL_PVU v 
                       inner join USRPVU.sisact_info_venta_sap@DBL_PVU vs
                       on vs.id_venta = v.id_documento
                where  vs.nro_documento = TO_CHAR(mssap60.ssapt_pedido.PEDIN_NROPEDIDO)
                and    vs.tipo_documento = 'F'
                )
        end
        ) ||'|'||
        '' ||'|'||
        'RETAIL' ||'|'||
        mssap60.ssapt_pedido.PEDIC_SECTOR ||'|'||
        mssap60.ssapt_interlocutor.intec_region ||'|'||
        mssap60.ssapt_interlocutor.intec_region ||'|'||
        mssap60.ssapt_pedido.intev_codinterlocutor ||'|'||
        mssap60.ssapt_interlocutor.intev_descinterlocutor ||'|'||
        mssap60.ssapt_interlocutor.intev_codpadre ||'|'||
        mssap60.ssapt_interlocutor.intev_descpadre ||'|'||
        mssap60.ssapt_interlocutor.intec_codalmacen ||'|'||
        mssap60.ssapt_interlocutor.intec_codcentro ||'|'||
        NULL ||'|'||
        case mssap60.ssapt_pedido.PEDIC_TIPOVENTA when '01' then 'POSTPAGO' when '02' then 'PREPAGO' when '07' then 'TFI' else null end ||'|'||
        mssap60.ssapt_pedido.pediv_descclasefactura ||'|'||
        decode(mssap60.ssapt_material.matec_tipomaterial, 'TV0004', 'CHIP', 'TV0003', 'EQUIPO', 'OTROS') ||'|'||
        mssap60.ssapt_detallepedido.depec_codmaterial ||'|'|| mssap60.ssapt_material.matev_descmaterial ||'|'|| mssap60.ssapt_detallepedido.seric_codserie ||'|'||
        0 ||'|'|| DECODE(ssapt_serie.seric_estado, 'PED', 'V', 'VEN', 'V', NULL,'V', 'L') ||'|'||
        mssap60.ssapt_detallepedido.depev_nrotelefono ||'|'|| '' ||'|'||
        decode(mssap60.ssapt_material.matec_tipomaterial, 'TV0004', mssap60.ssapt_detallepedido.depen_precioventa, 0) ||'|'||
        decode(mssap60.ssapt_material.matec_tipomaterial, 'TV0003', mssap60.ssapt_detallepedido.depen_precioventa, 0) ||'|'||
        mssap60.ssapt_intencionpago.inpan_totalmercaderia ||'|'||
        mssap60.ssapt_intencionpago.inpan_totaldescuento ||'|'||
        (
        select  sum(nvl(sdp.descn_monto,0))
        from    mssap60.ssapt_descuentoproducto sdp
        where   sdp.pedin_nropedido = mssap60.ssapt_pedido.pedin_nropedido
        and     sdp.descc_codserie = mssap60.ssapt_detallepedido.seric_codserie
        and     sdp.clcoc_codclasecondicion in ('ZD51','ZD54') -- descuento tributario
        ) ||'|'||
        (
        select  sum(sdp.descn_monto)
        from    mssap60.ssapt_descuentoproducto sdp
        where   sdp.pedin_nropedido = mssap60.ssapt_pedido.pedin_nropedido
        and     sdp.descc_codserie = mssap60.ssapt_detallepedido.seric_codserie
        and     sdp.clcoc_codclasecondicion in ('ZD52', 'ZD53' , 'ZD55') -- otros descuento
        ) ||'|'||
        mssap60.ssapt_intencionpago.inpan_totalconigv ||'|'||
        mssap60.ssapt_material.maten_preciobase ||'|'||
        mssap60.ssapt_detallepedido.depev_codigolp ||'|'||
        mssap60.ssapt_detallepedido.depev_descripcionlp ||'|'||
        to_char(mssap60.ssapt_detallepedido.Deped_Fechamodi, 'YYYYMMDD') ||'|'||
        mssap60.ssapt_pedido.pediv_sistemaventa ||'|'||
        '' ||'|'||
        '' ||'|'||
        mssap60.ssapt_detallepedido.deped_fechacrea
from mssap60.ssapt_pedido
inner join mssap60.ssapt_interlocutor
on mssap60.ssapt_interlocutor.intev_codinterlocutor = mssap60.ssapt_pedido.intev_codinterlocutor
and mssap60.ssapt_interlocutor.intec_canaldistribucion = '13' -- 12 distribuidores, 13 Cadenas
inner join mssap60.ssapt_detallepedido
on mssap60.ssapt_detallepedido.pedin_nropedido = mssap60.ssapt_pedido.pedin_nropedido
left join ssapt_serie
on ssapt_serie.seric_codserie = mssap60.ssapt_detallepedido.seric_codserie
inner join mssap60.ssapt_material
on mssap60.ssapt_material.matec_codmaterial = mssap60.ssapt_detallepedido.depec_codmaterial and mssap60.ssapt_material.matec_tipomaterial in ('TV0004','TV0003')
inner join mssap60.ssapt_intencionpago
on mssap60.ssapt_intencionpago.pedin_nropedido = mssap60.ssapt_pedido.pedin_nropedido
where mssap60.ssapt_pedido.pedic_estado = 'PAG' -- EJECUCION DE PAGO DESDE LEGADO
--and mssap60.ssapt_pedido.pediv_estadoflujo = '002'  -- HAN SIDO ENVIADO A SAP
and trunc(mssap60.ssapt_pedido.pedid_fechadocumento) = trunc(sysdate)
and mssap60.ssapt_pedido.pediv_sistemaventa != 'SISCAD'
union all
select 
        mssap60.ssapt_pedido.pedin_nropedido||'|'||  
        v.ventv_ticket_venta||'|'||
        '' ||'|'||
        'SISCAD' ||'|'||
        21 ||'|'||
        mssap60.ssapt_interlocutor.intec_region ||'|'||
        mssap60.ssapt_interlocutor.intec_region ||'|'||
        mssap60.ssapt_pedido.intev_codinterlocutor ||'|'||
        mssap60.ssapt_interlocutor.intev_descinterlocutor ||'|'||
        mssap60.ssapt_interlocutor.intev_codpadre ||'|'||
        mssap60.ssapt_interlocutor.intev_descpadre ||'|'||
        mssap60.ssapt_interlocutor.intec_codalmacen ||'|'||
        mssap60.ssapt_interlocutor.intec_codcentro ||'|'||
        '' ||'|'|| --FECHA_CONSIGNACION
                               case v.ventv_tipo_venta when 1 then 'POSTPAGO' when 2 then 'PREPAGO' when 3 then 'TFI' else 'ROBO' end ||'|'||
        --v.ventv_tipo_venta ||'|'||
        mssap60.ssapt_pedido.pediv_descclasefactura ||'|'||
        decode(mat.matec_tipomaterial, 'TV0004', 'CHIP', 'TV0003', 'EQUIPO', 'OTROS') ||'|'||
        mssap60.ssapt_detallepedido.depec_codmaterial ||'|'|| mat.matev_descmaterial ||'|'|| mssap60.ssapt_detallepedido.seric_codserie ||'|'||
        0 ||'|'|| --DIAS_CONSIGNADO
        DECODE(sti.seric_estado, 'PED', 'V', 'VEN', 'V', NULL, 'V', 'L')  ||'|'|| --ESTADO
        ov.ordv_nro_linea ||'|'|| '' ||'|'||
        decode(mat.matec_tipomaterial, 'TV0004', mssap60.ssapt_detallepedido.depen_precioventa, 0) ||'|'||
        decode(mat.matec_tipomaterial, 'TV0003', mssap60.ssapt_detallepedido.depen_precioventa, 0) ||'|'||
        mssap60.ssapt_intencionpago.inpan_totalmercaderia ||'|'||
        mssap60.ssapt_intencionpago.inpan_totaldescuento ||'|'||
        (
        select  sum(nvl(sdp.descn_monto,0))
        from    mssap60.ssapt_descuentoproducto sdp
        where   sdp.pedin_nropedido = mssap60.ssapt_pedido.pedin_nropedido
        and     sdp.descc_codserie = mssap60.ssapt_detallepedido.seric_codserie
        and     sdp.clcoc_codclasecondicion in ('ZD51','ZD54') -- descuento tributario
        ) ||'|'||
        (
        select  sum(sdp.descn_monto)
        from    mssap60.ssapt_descuentoproducto sdp
        where   sdp.pedin_nropedido = mssap60.ssapt_pedido.pedin_nropedido
        and     sdp.descc_codserie = mssap60.ssapt_detallepedido.seric_codserie
        and     sdp.clcoc_codclasecondicion in ('ZD52', 'ZD53' , 'ZD55') -- otros descuento
        ) ||'|'||
        mssap60.ssapt_intencionpago.inpan_totalconigv ||'|'||
        mat.maten_preciobase ||'|'||
        ov.catv_cod_lista_precio ||'|'||
        u.descripcion ||'|'||
        to_char(mssap60.ssapt_detallepedido.Deped_Fechamodi,'YYYYMMDD') ||'|'||
        mssap60.ssapt_pedido.pediv_sistemaventa ||'|'||
        '' ||'|'||
        '' ||'|'||
        mssap60.ssapt_detallepedido.deped_fechacrea
from mssap60.ssapt_pedido
inner join mssap60.ssapt_interlocutor
on mssap60.ssapt_interlocutor.intev_codinterlocutor = mssap60.ssapt_pedido.intev_codinterlocutor
and mssap60.ssapt_interlocutor.intec_canaldistribucion = '13' -- 12 distribuidores, 13 Cadenas
inner join mssap60.ssapt_detallepedido
on mssap60.ssapt_detallepedido.pedin_nropedido = mssap60.ssapt_pedido.pedin_nropedido
left join ssapt_serie sti
on sti.seric_codserie = mssap60.ssapt_detallepedido.seric_codserie
inner join mssap60.ssapt_material mat
on mat.matec_codmaterial = mssap60.ssapt_detallepedido.depec_codmaterial
inner join mssap60.ssapt_intencionpago
on mssap60.ssapt_intencionpago.pedin_nropedido = mssap60.ssapt_pedido.pedin_nropedido
INNER JOIN SISCAD.siscad_venta@DBL_SISCAD v 
ON mssap60.ssapt_pedido.pedin_nropedido = V.VENTV_NRO_PEDIDO_MSSAP
inner join SISCAD.siscad_orden_venta@DBL_SISCAD ov
on v.ventn_id_venta = ov.ordn_id_venta
INNER JOIN SISCAD.siscad_material@DBL_SISCAD sm
ON ov.ordn_id_material = sm.matn_id_material 
   AND 
   mssap60.ssapt_detallepedido.seric_codserie = 
   CASE WHEN sm.matv_tipo_mat = '01' THEN sm.matv_serie ELSE '000'||sm.matv_serie END
INNER join SISCAD.siscad_z_utilizacion@DBL_SISCAD u
on ov.catv_cod_lista_precio = u.codigo
where mssap60.ssapt_pedido.pedic_estado = 'PAG' -- EJECUCION DE PAGO DESDE LEGADO
AND v.ventv_estado = '02'
and v.VENTV_ORIGEN = 'SISCAD'
and mssap60.ssapt_pedido.pedic_issiscad = 1
and trunc(mssap60.ssapt_pedido.pedid_fechadocumento) = trunc(sysdate);

	
EXIT
EOP

sqlplus -S $USER_MSSAP/$PASSWORD_MSSAP@$BD_MSSAP <<FIN > ${DAT}_count

set arraysize 5000;
set flush on;
set buffer 500000000;
set heading off;
set feedback off;
set timing off;
set space 0;
set linesize 4000;
set echo off;
set trim on;
set termout on;
set serveroutput on size 50000;
set underline off;
set trims on;
set verify off;
set newpage none;


SELECT SUM(NUM_F) as N_Filas 
FROM
(
select COUNT(*) as NUM_F
from mssap60.ssapt_pedido
inner join mssap60.ssapt_interlocutor
on mssap60.ssapt_interlocutor.intev_codinterlocutor = mssap60.ssapt_pedido.intev_codinterlocutor
and mssap60.ssapt_interlocutor.intec_canaldistribucion = '12' -- 12 distribuidores, 13 Cadenas
inner join mssap60.ssapt_detallepedido
on mssap60.ssapt_detallepedido.pedin_nropedido = mssap60.ssapt_pedido.pedin_nropedido
left join mssap60.ssapt_stockimei
on mssap60.ssapt_stockimei.stckc_codserie = mssap60.ssapt_detallepedido.seric_codserie
inner join mssap60.ssapt_material mat
on mat.matec_codmaterial = mssap60.ssapt_detallepedido.depec_codmaterial and mat.matec_tipomaterial in ('TV0004','TV0003')
inner join mssap60.ssapt_intencionpago
on mssap60.ssapt_intencionpago.pedin_nropedido = mssap60.ssapt_pedido.pedin_nropedido
where mssap60.ssapt_pedido.pedic_estado = 'PAG' -- EJECUCION DE PAGO DESDE LEGADO
and trunc(mssap60.ssapt_pedido.pedid_fechadocumento) = trunc(sysdate)
--and sinergia_mssap.ssapt_pedido.pediv_estadoflujo = '002'  -- HAN SIDO ENVIADO A SAP
UNION ALL
select  COUNT(*) as NUM_F
from mssap60.ssapt_pedido
inner join mssap60.ssapt_interlocutor
on mssap60.ssapt_interlocutor.intev_codinterlocutor = mssap60.ssapt_pedido.intev_codinterlocutor
and mssap60.ssapt_interlocutor.intec_canaldistribucion = '13' -- 12 distribuidores, 13 Cadenas
inner join mssap60.ssapt_detallepedido
on mssap60.ssapt_detallepedido.pedin_nropedido = mssap60.ssapt_pedido.pedin_nropedido
left join ssapt_serie
on ssapt_serie.seric_codserie = mssap60.ssapt_detallepedido.seric_codserie
inner join mssap60.ssapt_material
on mssap60.ssapt_material.matec_codmaterial = mssap60.ssapt_detallepedido.depec_codmaterial and mssap60.ssapt_material.matec_tipomaterial in ('TV0004','TV0003')
inner join mssap60.ssapt_intencionpago
on mssap60.ssapt_intencionpago.pedin_nropedido = mssap60.ssapt_pedido.pedin_nropedido
where mssap60.ssapt_pedido.pedic_estado = 'PAG' -- EJECUCION DE PAGO DESDE LEGADO
--and mssap60.ssapt_pedido.pediv_estadoflujo = '002'  -- HAN SIDO ENVIADO A SAP
and trunc(mssap60.ssapt_pedido.pedid_fechadocumento) = trunc(sysdate)
and mssap60.ssapt_pedido.pediv_sistemaventa != 'SISCAD'
union all
select  COUNT(*) as NUM_F
from mssap60.ssapt_pedido
inner join mssap60.ssapt_interlocutor
on mssap60.ssapt_interlocutor.intev_codinterlocutor = mssap60.ssapt_pedido.intev_codinterlocutor
and mssap60.ssapt_interlocutor.intec_canaldistribucion = '13' -- 12 distribuidores, 13 Cadenas
inner join mssap60.ssapt_detallepedido
on mssap60.ssapt_detallepedido.pedin_nropedido = mssap60.ssapt_pedido.pedin_nropedido
left join ssapt_serie sti
on sti.seric_codserie = mssap60.ssapt_detallepedido.seric_codserie
inner join mssap60.ssapt_material mat
on mat.matec_codmaterial = mssap60.ssapt_detallepedido.depec_codmaterial
inner join mssap60.ssapt_intencionpago
on mssap60.ssapt_intencionpago.pedin_nropedido = mssap60.ssapt_pedido.pedin_nropedido
INNER JOIN SISCAD.siscad_venta@DBL_SISCAD v 
ON mssap60.ssapt_pedido.pedin_nropedido = V.VENTV_NRO_PEDIDO_MSSAP
inner join SISCAD.siscad_orden_venta@DBL_SISCAD ov
on v.ventn_id_venta = ov.ordn_id_venta
INNER JOIN SISCAD.siscad_material@DBL_SISCAD sm
ON ov.ordn_id_material = sm.matn_id_material 
   AND 
   mssap60.ssapt_detallepedido.seric_codserie = 
   CASE WHEN sm.matv_tipo_mat = '01' THEN sm.matv_serie ELSE '000'||sm.matv_serie END
INNER join SISCAD.siscad_z_utilizacion@DBL_SISCAD u
on ov.catv_cod_lista_precio = u.codigo
where mssap60.ssapt_pedido.pedic_estado = 'PAG' -- EJECUCION DE PAGO DESDE LEGADO
AND v.ventv_estado = '02'
and v.VENTV_ORIGEN = 'SISCAD'
and mssap60.ssapt_pedido.pedic_issiscad = 1
and trunc(mssap60.ssapt_pedido.pedid_fechadocumento) = trunc(sysdate));

EXIT
FIN

RESULTADO=$?
RESULT=`cat ${DAT}_count | sed 's/^[ \t]*//;s/[ \t]*$//'`
pMessage "Muestro el count de registros exportados: $RESULT"
#cat ${DAT}_count | sed 's/^[ \t]*//;s/[ \t]*$//'

#Calculamos el numero de registros de la tabla

NREGISTROS=`cat ${DAT}_count |awk '{print $1}'`
rm ${DAT}_count

#Numero de registros debe coincidir con el numero de lineas del archivo de descarga

LINEAS_ARCH_DESCARGA=`wc -l $DAT |awk '{print $1}'`

num=1

LINEAS_ARCH_DESCARGA1=`expr $LINEAS_ARCH_DESCARGA - $num`


pMessage "Lineas archivo descarga: ${LINEAS_ARCH_DESCARGA1}"
#echo $LINEAS_ARCH_DESCARGA
pMessage "Numero de registros: ${NREGISTROS}"
#echo $NREGISTROS

if [ ! $RESULTADO -eq 0 ]; 
then 
	exitScript $RESULTADO "Error-- Ejecucion  fichero: (${RESULTADO})"
else	
	if [ $LINEAS_ARCH_DESCARGA1 -eq 0 ]
	then
		pMessage "El fichero no cuenta con registros."$'\n'
		pMessage "************************************* "
		pMessage "Finalizando proceso                     "
		pMessage "Fecha y Hora  : ${hora}               "
		pMessage "Usuario :  ${USUARIO}                 "
		pMessage "Shell : ${SHELL}                      "
		pMessage "Ip : ${IP_ORIGEN}                     "
		pMessage "Host : ${HOST}                        "
		pMessage "**************************************"$'\n'
		rm ${DAT}
		exit 0
	else
		if [ ! $LINEAS_ARCH_DESCARGA1 -eq $NREGISTROS ] 
		then 
			pMessage "Error-- Descarga fichero incorrecta: Numero registros del fichero de descarga ($LINEAS_ARCH_DESCARGA1) no coincide con el numero de registros de la tabla ($NREGISTROS)"             
		else 
			pMessage "Descarga fichero correcta: Numero registros del fichero de descarga ($LINEAS_ARCH_DESCARGA1) coincide con el numero de registros de la tabla ($NREGISTROS)"
			pMessage "Ejecucion fichero correcta: (${RESULTADO})"
		fi
	fi
fi

ftp -n -v ${IP_FTP} <<xxEOF2
user ${USER_FTP} ${PASS_FTP}
lcd ${DIRDAT}
cd ${DESTINO_FTP}
ascii
prompt off
mput ${ARCHIVO_EXP}
ls ${ARCHIVO_EXP}
pwd
bye
xxEOF2

pMessage "Moviendo ${DAT} a ruta destino... ${USER_FTP}@${IP_FTP}:${DESTINO_FTP}"$'\n'

sqlplus -S ${USER_MSSAP}/${PASSWORD_MSSAP}@${BD_MSSAP} <<EOP > ${DAT_TELEVENTAS}
set arraysize 5000;
set flush on;
set buffer 500000000;
set heading off;
set feedback off;
set timing off;
set space 0;
set linesize 4000;
set echo off;
set trim on;
set termout on;
set serveroutput on size 50000;
set underline off;
set trims on;
set verify off;
set newpage none;

select 'pedido|nombrecliente|nrodoccliente|fechadocumento|direccioncliente|referenciadoc|contactocliente|codigomaterial|depen_cantidad|unidad|descmaterial|serie|referenciasunat' from dual
union all
select a.pedin_nropedido || '|' ||
       c.cliev_nombrecliente||' '||c.cliev_paternocliente||' '||c.cliev_maternocliente || '|' ||
       c.cliev_nrodoccliente || '|' ||
       to_char(trunc(a.pedid_fechadocumento),'yyyymmdd') || '|' ||
       c.cliev_direccioncliente||' - '||e.distv_descripcion||' - '||f.depav_descripcion || '|' ||
       a.pedin_nropedido || '|' ||
       c.cliev_nombrecliente||' '||c.cliev_paternocliente||' '||c.cliev_maternocliente || '|' ||
       b.depec_codmaterial || '|' ||
       b.depen_cantidad || '|' ||
       'UN' || '|' ||
       b.depev_descmaterial || '|' ||
       b.seric_codserie || '|' ||
       null || '|' ||
       a.OFICV_CODOFICINA
  from mssap60.ssapt_cliente c,
       mssap60.ssapt_pedido a,
       mssap60.ssapt_detallepedido b,
       usrpvu.sect_distrito@dbl_pvu e,
       usrpvu.sect_departamento@dbl_pvu f
where a.oficv_codoficina in ('${OFICINAS_TLV}')
   and a.pedin_nropedido = b.pedin_nropedido
   and a.pedid_fechadocumento >= trunc(sysdate)
   and a.pedic_isrenta != 'S'
   and a.pedic_estado != 'ANU'
   and a.pedic_tipodoccliente = c.cliec_tipodoccliente
   and a.pediv_nrodoccliente = c.cliev_nrodoccliente
   and c.cliev_distritocliente = e.distc_codigo (+)
   and e.depac_codigo = f.depac_codigo (+);


EXIT
EOP

sqlplus -S $USER_MSSAP/$PASSWORD_MSSAP@$BD_MSSAP <<FIN > ${DAT_TELEVENTAS}_count

set arraysize 5000;
set flush on;
set buffer 500000000;
set heading off;
set feedback off;
set timing off;
set space 0;
set linesize 4000;
set echo off;
set trim on;
set termout on;
set serveroutput on size 50000;
set underline off;
set trims on;
set verify off;
set newpage none;

select COUNT(1)
  from mssap60.ssapt_cliente c,
       mssap60.ssapt_pedido a,
       mssap60.ssapt_detallepedido b,
       usrpvu.sect_distrito@dbl_pvu e,
       usrpvu.sect_departamento@dbl_pvu f
where a.oficv_codoficina in ('${OFICINAS_TLV}')
   and a.pedin_nropedido = b.pedin_nropedido
   and a.pedid_fechadocumento >= trunc(sysdate)
   and a.pedic_isrenta != 'S'
   and a.pedic_estado != 'ANU'
   and a.pedic_tipodoccliente = c.cliec_tipodoccliente
   and a.pediv_nrodoccliente = c.cliev_nrodoccliente
   and c.cliev_distritocliente = e.distc_codigo (+)
   and e.depac_codigo = f.depac_codigo (+);

EXIT
FIN

ftp -n -v ${IP_FTP} <<xxEOF2
user ${USER_FTP} ${PASS_FTP}
lcd ${DIRDAT}
cd ${DESTINO_FTP}
ascii
prompt off
mput ${ARCHIVO_EXP_TLV}
ls ${ARCHIVO_EXP_TLV}
pwd
bye
xxEOF2

pMessage "************************************* "
pMessage "Finalizando proceso                   "
pMessage "Fecha y Hora  : ${hora}               "
pMessage "Usuario :  ${USUARIO}                 "
pMessage "Shell : ${SHELL}                      "
pMessage "Ip : ${IP_ORIGEN}                     "
pMessage "Host : ${HOST}                        "
pMessage "**************************************"$'\n'

exit 0